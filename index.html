<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 创意工坊</title>
    <!-- FIX: Changed script URLs to use https:// -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f7fafc; }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 1rem;
            height: 100vh;
            padding: 1rem;
        }
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .preview-panel {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: white;
        }
        textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            resize: vertical;
        }
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #4338ca; }
        button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        #export-btn { background-color: #16a34a; }
        #export-btn:hover { background-color: #15803d; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- 左侧：控制面板 -->
        <div class="controls-panel">
            <div class="p-4 bg-white rounded-lg shadow-sm">
                <label for="user-material" class="font-bold text-gray-700">1. 输入素材</label>
                <textarea id="user-material" rows="10" placeholder="在这里粘贴您的文案、笔记或任何原始素材..."></textarea>
            </div>

            <div class="p-4 bg-white rounded-lg shadow-sm">
                <label for="template-select" class="font-bold text-gray-700">2. 选择模板 (可选)</label>
                <select id="template-select">
                    <option value="">正在加载模板...</option>
                </select>
            </div>

            <div class="p-4 bg-white rounded-lg shadow-sm">
                <label for="user-dialog" class="font-bold text-gray-700">3. 输入要求</label>
                <textarea id="user-dialog" rows="4" placeholder="例如：帮我把这段文字改成三页卡片，风格要温馨一点..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <button id="generate-btn" class="w-full">生成网页</button>
                <button id="export-btn" class="w-full">导出预览为 PNG</button>
            </div>
            <p id="status" class="text-sm text-center text-gray-500"></p>
        </div>

        <!-- 右侧：预览面板 -->
        <div class="preview-panel">
            <iframe id="preview-frame" srcdoc="<p style='text-align:center; margin-top: 2rem; color: #9ca3af;'>请先启动Python后端，然后刷新页面</p>"></iframe>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://127.0.0.1:8000';

        async function loadTemplates() {
            const selectEl = document.getElementById('template-select');
            try {
                const response = await fetch(`${BACKEND_URL}/templates`);
                if (!response.ok) throw new Error('无法连接到后端服务');
                const templates = await response.json();
                
                selectEl.innerHTML = '<option value="">不使用模板 (最小化输出)</option>';
                
                templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.filename;
                    option.textContent = `${template.display_name} [${template.tags.格式}]`;
                    selectEl.appendChild(option);
                });

            } catch (error) {
                console.error('加载模板失败:', error);
                selectEl.innerHTML = `<option value="">加载模板失败: ${error.message}</option>`;
            }
        }

        async function generate() {
            // ... (此函数无需修改)
            const generateBtn = document.getElementById('generate-btn');
            const statusEl = document.getElementById('status');
            const previewFrame = document.getElementById('preview-frame');
            const userMaterial = document.getElementById('user-material').value;
            const userDialog = document.getElementById('user-dialog').value;
            const selectedTemplate = document.getElementById('template-select').value;

            if (!userMaterial && !userDialog) {
                statusEl.textContent = '请输入素材或要求！';
                return;
            }

            generateBtn.disabled = true;
            statusEl.textContent = '正在请求 Gemini，请稍候...';
            previewFrame.srcdoc = `<p style='text-align:center; margin-top: 2rem; color: #9ca3af;'>生成中，请耐心等待...</p>`;

            try {
                const requestData = {
                    system_prompt: "你是一个专业的前端工程师，擅长用HTML和Tailwind CSS创建富有美感的卡片式网页。请根据用户提供的模板、素材和要求，直接生成完整的、可运行的HTML代码。重要：你的代码中不要包含任何导出按钮或html2canvas相关的脚本。",
                    template_filename: selectedTemplate || null,
                    user_material: userMaterial,
                    user_dialog: userDialog
                };

                const response = await fetch(`${BACKEND_URL}/generate-html`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) throw new Error(`HTTP 错误! 状态: ${response.status}`);
                const result = await response.json();

                if (result.success) {
                    previewFrame.srcdoc = result.html;
                    statusEl.textContent = '生成成功！';
                } else {
                    throw new Error(result.error || '后端返回了一个未知错误。');
                }

            } catch (error) {
                console.error('请求失败:', error);
                statusEl.textContent = `生成失败: ${error.message}`;
                previewFrame.srcdoc = `<p style='text-align:center; margin-top: 2rem; color: #ef4444;'>发生错误，请检查Python后端是否已启动，或查看控制台日志。</p>`;
            } finally {
                generateBtn.disabled = false;
            }
        }

        async function exportPreview() {
            const exportBtn = document.getElementById('export-btn');
            const statusEl = document.getElementById('status');
            const previewFrame = document.getElementById('preview-frame');
            const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            if (!iframeDoc) {
                statusEl.textContent = '预览为空，无法导出。';
                return;
            }
            const elementsToCapture = iframeDoc.querySelectorAll('.card, .card-container');
            if (elementsToCapture.length === 0) {
                statusEl.textContent = '在预览中未找到可导出的卡片。';
                return;
            }
            exportBtn.disabled = true;
            for (let i = 0; i < elementsToCapture.length; i++) {
                const element = elementsToCapture[i];
                statusEl.textContent = `正在导出... (${i + 1}/${elementsToCapture.length})`;
                try {
                    // *** FIX: Changed backgroundColor to null ***
                    // This lets html2canvas capture the element's true appearance,
                    // including gradients or backgrounds from parent elements.
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        useCORS: true,
                        backgroundColor: null,
                    });
                    const link = document.createElement('a');
                    link.download = `export-card-${i + 1}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (err) {
                    console.error('导出失败:', err);
                    statusEl.textContent = `导出第 ${i + 1} 张卡片时失败。`;
                    break; 
                }
            }
            statusEl.textContent = `导出完成！共 ${elementsToCapture.length} 张。`;
            exportBtn.disabled = false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generate-btn').addEventListener('click', generate);
            document.getElementById('export-btn').addEventListener('click', exportPreview);
            loadTemplates();
        });
    </script>
</body>
</html>
